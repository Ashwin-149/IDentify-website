{% extends "base.html" %}
{% block title %}{{ event.title }} · IDentify{% endblock %}

{% block content %}
<a class="text-decoration-none" href="{{ url_for('events_list') }}">
  <i class="bi bi-arrow-left"></i> Back to Events
</a>

<div class="row mt-3 g-4">
  <div class="col-12 col-lg-7">
    <div class="card shadow-sm">
      {% if event.cover_url %}

      <img
        src="{{ event.cover_url }}"
        class="card-img-top"
        alt="cover"
        style="cursor: zoom-in; object-fit: cover;"
        data-bs-toggle="modal"
        data-bs-target="#imageModal"
      >
      {% endif %}

      <div class="card-body">
        <h3 class="card-title">{{ event.title }}</h3>
        <p class="text-muted mb-1">
          <i class="bi bi-calendar-event"></i>
          {{ event.start_pretty }}{% if event.end_pretty %} – {{ event.end_pretty }}{% endif %}
        </p>

        {% if event.location %}
        <p class="text-muted"><i class="bi bi-geo-alt"></i> {{ event.location }}</p>
        {% endif %}
        {% if event.capacity %}
        <p><span class="badge bg-info text-dark">Capacity: {{ registered_count }}/{{ event.capacity }}</span></p>
        {% endif %}

        <hr>

        <!-- Description container; any image inside will open the zoom modal -->
        <div id="event-content" style="line-height: 1.6;">
          {{ event.description|safe }}
        </div>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-5">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title"><i class="bi bi-pencil-square me-1"></i> Register</h5>
        <form method="post" action="{{ url_for('event_register', slug=event.slug) }}">
          <div class="mb-3">
            <label class="form-label">Registration Number<span class="text-danger">*</span></label>
            <input name="reg_number" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Name</label>
            <input name="name" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input name="email" type="email" class="form-control">
          </div>
          <button type="submit" class="btn btn-primary w-100">Register</button>
        </form>
      </div>
    </div>

    <div>
      {% if current_user.is_authenticated %}
        <hr class="mt-4">
        <div class="d-flex flex-wrap gap-2 mt-2">
          <a class="btn btn-outline-success btn-sm"
             href="{{ url_for('admin_event_registrations', event_id=event.id) }}">
            <i class="bi bi-people"></i> View registrations
          </a>

          <a class="btn btn-outline-primary btn-sm"
             href="{{ url_for('admin_export_regs_csv', event_id=event.id) }}">
            <i class="bi bi-file-earmark-spreadsheet"></i> Export to Excel
          </a>

          <form method="post"
                action="{{ url_for('admin_delete_event_by_slug', slug=event.slug) }}"
                onsubmit="return confirm('Delete this event? This cannot be undone.');">
            <button type="submit" class="btn btn-outline-danger btn-sm">
              <i class="bi bi-trash"></i> Delete Event
            </button>
          </form>
        </div>

        <div class="d-flex flex-wrap gap-2 mt-3">
          <a class="btn btn-outline-info btn-sm"
             href="{{ url_for('admin_view_event_logs', event_id=event.id) }}">
            <i class="bi bi-list-ul"></i> View event logs
          </a>
          <form method="post"
                action="{{ url_for('admin_reset_event_logs_by_event', event_id=event.id) }}"
                class="m-0 p-0"
                onsubmit="return confirm('Reset logs for this event? This cannot be undone.');">
            <button type="submit" class="btn btn-outline-danger btn-sm">
              <i class="bi bi-trash"></i> Reset event logs
            </button>
          </form>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Image zoom modal (reused for banner and any description images) -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content bg-transparent border-0">
      <button type="button" class="btn-close btn-close-white ms-auto me-2 mt-2" data-bs-dismiss="modal" aria-label="Close"></button>
      <div class="modal-body p-0 d-flex justify-content-center">
        <img id="zoomedImg" class="img-fluid rounded shadow" style="max-height: 90vh;" alt="Zoomed image">
      </div>
    </div>
  </div>
</div>

<!-- Light JS to wire up click-to-zoom for description images and banner -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const zoomImgEl = document.getElementById('zoomedImg');
    const modalEl = document.getElementById('imageModal');
    const zoomModal = new bootstrap.Modal(modalEl);

    // 1) Banner click: Bootstrap data attributes already open modal.
    //    Set banner into zoomedImg when modal opens if triggered by banner.
    const banner = document.querySelector('.card-img-top[alt="cover"]');
    if (banner) {
      banner.addEventListener('click', function() {
        zoomImgEl.src = banner.getAttribute('src');
      });
    }

    // 2) Any image inside description
    const content = document.getElementById('event-content');
    if (content) {
      content.addEventListener('click', function(e) {
        const t = e.target;
        if (t && t.tagName === 'IMG') {
          zoomImgEl.src = t.getAttribute('src');
          zoomModal.show();
        }
      });
      // Cursor hint for images inside description
      const imgs = content.querySelectorAll('img');
      imgs.forEach(img => { img.style.cursor = 'zoom-in'; });
    }
  });
</script>
{% endblock %}
